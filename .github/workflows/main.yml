name: Auto Fix Gradle & Build Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect project folder
      id: detect
      run: |
        if [ -d "Advanced-Camera-Pro" ]; then
          echo "project_path=Advanced-Camera-Pro" >> $GITHUB_ENV
        else
          echo "project_path=." >> $GITHUB_ENV
        fi

    - name: Move into project directory
      run: cd "$project_path"

    - name: Install Java 17
      uses: actions/setup-java@v4
      with:
        java-version: 17
        distribution: temurin

    - name: Install Gradle 8.5
      run: |
        wget https://services.gradle.org/distributions/gradle-8.5-bin.zip
        unzip gradle-8.5-bin.zip
        echo "PATH=$PATH:$(pwd)/gradle-8.5/bin" >> $GITHUB_ENV

    - name: Generate Gradle Wrapper if missing
      run: |
        cd "$project_path"
        if [ ! -f gradlew ]; then
          echo "Gradle wrapper missing â€” generating..."
          gradle wrapper --gradle-version 8.5
        fi
        chmod +x gradlew

    - name: Build Debug APK
      run: |
        cd "$project_path"
        ./gradlew assembleDebug --warning-mode=none

    - name: Build Release APK
      run: |
        cd "$project_path"
        ./gradlew assembleRelease --warning-mode=none

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: ${{ env.project_path }}/app/build/outputs/apk/debug/*.apk

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: ${{ env.project_path }}/app/build/outputs/apk/release/*.apk
