name: Build APK and Show Errors

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Setup Gradle Wrapper (only if missing)
      - name: Setup Gradle Wrapper
        run: |
          if [ ! -f "./gradlew" ]; then
            gradle wrapper --gradle-version 8.6
          fi

      # 4. Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x gradlew

      # 5. Build Project & Capture Errors
      - name: Build Debug APK (Capture All Errors)
        run: |
          echo "üîß Building APK... (Logging to build_output.txt)"
          
          # Build & Save full logs
          ./gradlew assembleDebug --no-daemon --stacktrace > build_output.txt 2>&1 || true
          
          echo ""
          echo "----------------------------------------------"
          echo "üîç REAL ERRORS FOUND (Filtered)"
          echo "----------------------------------------------"
          
          # Filter only real Kotlin / Gradle / AAPT / TFLite errors
          grep -n "e: " build_output.txt || true
          grep -n "error:" build_output.txt || true
          grep -n "Exception" build_output.txt || true
          grep -n "FAILURE:" build_output.txt || true
          grep -n "Caused by" build_output.txt || true
          
          echo "----------------------------------------------"
          echo "Full logs saved in build_output.txt"
          echo "----------------------------------------------"

      # 6. Upload full logs for checking
      - name: Upload Full Error Log
        uses: actions/upload-artifact@v4
        with:
          name: full-build-log
          path: build_output.txt

      # 7. Upload APK (only if created)
      - name: Upload APK
        if: success() || always()
        uses: actions/upload-artifact@v4
        with:
          name: Debug-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: ignore
